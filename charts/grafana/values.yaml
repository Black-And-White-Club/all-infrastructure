# Grafana values - Shared visualization for resume and frolf-bot
# Metrics: Mimir (replaces Prometheus)
# Logs: Loki
# Traces: Tempo
# Collection: Alloy

resources:
  requests:
    cpu: 25m
    memory: 128Mi
  limits:
    cpu: 500m
    memory: 512Mi

# Security context - run as grafana user (472)
securityContext:
  runAsUser: 472
  runAsGroup: 472
  fsGroup: 472

# Init container to fix volume permissions
initChownData:
  enabled: true
  runAsUser: 0
  runAsNonRoot: false

persistence:
  enabled: true
  storageClassName: local-storage
  volumeName: grafana-pv
  size: 2Gi

# Admin password - MUST be set via sealed secret before production deployment
# DO NOT set directly here for production. Use a secure mechanism (sealed secret or values override).
# Generate random password: kubectl create secret generic grafana-admin-password \
#   --from-literal=admin-password=$(openssl rand -base64 32) --dry-run=client -o yaml | \
#   kubeseal --controller-name sealed-secrets --controller-namespace kube-system -o yaml
# For development only, leave empty to use Grafana's auto-generated password
adminPassword: ""

admin:
  existingSecret: grafana-admin-secret
  userKey: admin-user
  passwordKey: admin-password

# Datasource configuration
datasources:
  datasources.yaml:
    apiVersion: 1
    datasources:
      # Metrics datasource - Mimir (Prometheus-compatible)
      - name: Mimir
        type: prometheus
        url: http://mimir-gateway.observability.svc.cluster.local:8080/prometheus
        access: proxy
        isDefault: true
        editable: true
        jsonData:
          timeInterval: 15s
          exemplarTraceIdDestinations:
            - name: TraceID
              url: http://localhost:3000/explore?orgId=1&left=%5B%22now-1h%22,%22now%22,%22Tempo%22,%7B%22refId%22:%22A%22,%22queryType%22:%22traceql%22,%22expr%22:%22$${__value.raw}%22%7D%5D

      # Logs datasource - Loki
      - name: Loki
        type: loki
        url: http://loki-gateway.observability.svc.cluster.local
        access: proxy
        editable: true
        jsonData:
          derivedFields:
            - name: TraceID
              matcherRegex: 'trace[_id]*=([^\s]*)'
              url: http://localhost:3000/explore?orgId=1&left=%5B%22now-1h%22,%22now%22,%22Tempo%22,%7B%22refId%22:%22A%22,%22queryType%22:%22traceql%22,%22expr%22:%22$${__value.raw}%22%7D%5D

      # Traces datasource - Tempo
      - name: Tempo
        type: tempo
        url: http://tempo-query-frontend.observability.svc.cluster.local:3200
        access: proxy
        editable: true
        jsonData:
          tracesToLogs:
            datasourceUid: loki
            mappedTags:
              - key: service.name
                value: service
              - key: pod.name
                value: pod
              - key: namespace
                value: namespace
          tracesToMetrics:
            datasourceUid: mimir
            spanStartTimeShift: 1s
            spanEndTimeShift: 100ms
          searchEnabled: true
          serviceMap:
            datasourceUid: mimir

# Default dashboard folders
# dashboardProviders:
#   dashboardproviders.yaml:
#     apiVersion: 1
#     providers:
#       - name: "observability"
#         orgId: 1
#         folder: "Observability"
#         type: file
#         disableDeletion: false
#         editable: true
#         options:
#           path: /var/lib/grafana/dashboards/observability
#       - name: "resume"
#         orgId: 1
#         folder: "Resume"
#         type: file
#         disableDeletion: false
#         editable: true
#         options:
#           path: /var/lib/grafana/dashboards/resume
#       - name: "frolf-bot"
#         orgId: 1
#         folder: "Frolf Bot"
#         type: file
#         disableDeletion: false
#         editable: true
#         options:
#           path: /var/lib/grafana/dashboards/frolf-bot

ingress:
  enabled: true
  ingressClassName: nginx
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-prod
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
  hosts:
    - grafana.jaromero.cloud
  path: /
  pathType: Prefix
  tls:
    - secretName: grafana-tls
      hosts:
        - grafana.jaromero.cloud
