# Tempo Distributed - Distributed tracing backend
# Stores distributed traces from all services
# Query via Grafana with trace IDs or service filters
# Stores trace blocks in OCI Object Storage

# Note: Don't use global.extraArgs/extraEnvFrom - they bleed into memcached
# Instead, set them per-component below

# Enable OTLP trace ingestion (gRPC on 4317, HTTP on 4318)
traces:
  otlp:
    grpc:
      enabled: true
    http:
      enabled: true

# Distributor receives traces and forwards to ingesters
distributor:
  replicas: 1
  extraEnvFrom:
    - secretRef:
        name: objectstore-creds
  extraArgs:
    - -config.expand-env=true
  resources:
    requests:
      cpu: 10m
      memory: 64Mi
    limits:
      cpu: 200m
      memory: 256Mi

# Ingester writes traces to storage
ingester:
  replicas: 1
  extraEnvFrom:
    - secretRef:
        name: objectstore-creds
  extraArgs:
    - -config.expand-env=true
  config:
    replication_factor: 1
  persistence:
    enabled: false
  resources:
    requests:
      cpu: 10m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 512Mi

# Compactor handles block compaction and retention
compactor:
  replicas: 1
  extraEnvFrom:
    - secretRef:
        name: objectstore-creds
  extraArgs:
    - -config.expand-env=true
  config:
    compaction:
      block_retention: 48h
      compacted_block_retention: 10m
      compaction_window: 1h
      max_block_bytes: 107374182400
  resources:
    requests:
      cpu: 10m
      memory: 64Mi
    limits:
      cpu: 200m
      memory: 256Mi

# Querier handles trace queries
querier:
  replicas: 1
  extraEnvFrom:
    - secretRef:
        name: objectstore-creds
  extraArgs:
    - -config.expand-env=true
  resources:
    requests:
      cpu: 10m
      memory: 64Mi
    limits:
      cpu: 200m
      memory: 256Mi

# Query frontend handles query scheduling
queryFrontend:
  replicas: 1
  extraEnvFrom:
    - secretRef:
        name: objectstore-creds
  extraArgs:
    - -config.expand-env=true
  resources:
    requests:
      cpu: 10m
      memory: 64Mi
    limits:
      cpu: 200m
      memory: 256Mi

# Storage configuration - OCI Object Storage via S3 API
storage:
  trace:
    backend: s3
    s3:
      bucket: tempo-shared-bucket
      endpoint: id2uwn5pyixh.compat.objectstorage.us-ashburn-1.oraclecloud.com
      region: us-ashburn-1
      access_key: ${TEMPO_OCI_ACCESS_KEY}
      secret_key: ${TEMPO_OCI_SECRET_KEY}
      insecure: false
      forcepathstyle: true
    wal:
      path: /var/tempo/wal

# Memcached for caching
memcached:
  enabled: false
  replicas: 1
  # Clear any inherited values from global - memcached doesn't need these
  extraEnvFrom: []
  extraArgs: []
  resources:
    requests:
      cpu: 10m
      memory: 32Mi
    limits:
      cpu: 100m
      memory: 128Mi

# Metrics generator - generates RED metrics from traces for TraceQL metrics queries
metricsGenerator:
  enabled: true
  replicas: 1
  extraEnvFrom:
    - secretRef:
        name: objectstore-creds
  extraArgs:
    - -config.expand-env=true
  config:
    registry:
      external_labels:
        source: tempo
        cluster: oci-k8s
    processor:
      service_graphs:
        dimensions:
          - service.namespace
          - http.method
          - http.status_code
      span_metrics:
        dimensions:
          - service.namespace
          - http.method
          - http.status_code
          - http.route
    storage:
      path: /var/tempo/wal
      # Remote write to Mimir for metrics storage
      remote_write:
        - url: http://mimir-distributor.observability.svc:8080/api/v1/push
  resources:
    requests:
      cpu: 15m
      memory: 64Mi
    limits:
      cpu: 150m
      memory: 256Mi
