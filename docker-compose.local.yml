# =============================================================================
# Frolf Bot - Local Development Stack
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # Infrastructure Services
  # ---------------------------------------------------------------------------

  postgres:
    image: postgres:15-alpine
    container_name: frolf-postgres-local
    environment:
      POSTGRES_USER: local
      POSTGRES_PASSWORD: local
      POSTGRES_DB: frolf_bot
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U local -d frolf_bot"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - frolf-network

  nats:
    image: nats:2.10-alpine
    container_name: frolf-nats-local
    command: ["-c", "/etc/nats/nats.conf"]
    ports:
      - "4222:4222"
      - "4443:4443"
      - "8222:8222"
      - "6222:6222"
    volumes:
      - nats_data:/data
      - ./config/nats.conf:/etc/nats/nats.conf:ro
    healthcheck:
      test:
        ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8222/healthz"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - frolf-network

  # ---------------------------------------------------------------------------
  # PWA Frontend (DEV MODE â€” NO IMAGE BUILD)
  # ---------------------------------------------------------------------------

  pwa:
    image: oven/bun:1-alpine
    container_name: frolf-pwa-local
    working_dir: /app
    # CHANGE 1: We put 'bun install' back, but it will be instant (cached)
    command: >
      sh -c "
      bun install &&
      bun run dev --host
      "
    volumes:
      - ../frolf-bot-pwa:/app
      # CHANGE 2: This 'Anonymous Volume' tells Docker: 
      # 'Do NOT look at the host folder for this path. Use your own internal storage.'
      - /app/node_modules
      - bun_cache:/root/.bun
    env_file:
      - ../frolf-bot-pwa/.env.local
      - ../discord-frolf-bot/.env
    environment:
      # ... (keep your existing env vars) ...
      VITE_NATS_URL: ws://localhost:4443
      VITE_API_URL: http://host.docker.internal:3001
      VITE_OTEL_ENDPOINT: ""
      VITE_USE_MOCK: "false"
      VITE_DEBUG: "true"
      AUTH_TRUST_HOST: "true"
      ORIGIN: http://localhost:5173
    ports:
      - "5173:5173"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      postgres:
        condition: service_healthy
      nats:
        condition: service_healthy
    networks:
      - frolf-network
    profiles:
      - with-pwa

# -----------------------------------------------------------------------------
# Volumes & Networks
# -----------------------------------------------------------------------------

volumes:
  postgres_data:
    driver: local
  nats_data:
    driver: local
  bun_cache:
    driver: local

networks:
  frolf-network:
    driver: bridge
