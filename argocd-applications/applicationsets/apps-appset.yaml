apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: apps-appset
  namespace: argocd
  annotations:
    argocd.argoproj.io/sync-wave: "20"

spec:
  goTemplate: true

  generators:
    - git:
        repoURL: https://github.com/Black-And-White-Club/all-infrastructure.git
        revision: main
        files:
          - path: "argocd-applications/apps-descriptors/*.yaml"

  template:
    metadata:
      name: '{{ .name }}'
      annotations:
        argocd.argoproj.io/sync-wave: '{{ default "21" .syncWave }}'

    spec:
      project: '{{ default "default" .project }}'
      
      # We define destination here as it's a standard scalar structure
      destination:
        server: '{{ default "https://kubernetes.default.svc" .destination.server }}'
        namespace: '{{ default "default" .destination.namespace }}'

      # We define a default syncPolicy here. 
      # If the user provides one in the descriptor, we will overwrite it in the patch below.
      syncPolicy:
        automated:
          prune: false
          selfHeal: false

      ignoreDifferences:
        - group: argoproj.io
          kind: Application
          jsonPointers:
            - /spec/syncPolicy
            - /spec/syncWindows

      preservedFields:
        annotations:
          - argocd.argoproj.io/skip-reconcile

  # ---------------------------------------------------------------------------
  # TEMPLATE PATCH
  # ---------------------------------------------------------------------------
  # We use templatePatch for 'sources' and complex 'syncPolicy' logic.
  # This is required because {{ range }} or {{ toYaml }} loops are invalid 
  # syntax in the main YAML 'template' structure above.
  # ---------------------------------------------------------------------------
  templatePatch: |
    spec:
      # Handle Source / Sources
      {{- if .sources }}
      sources:
{{ toYaml .sources | indent 6 }}
      {{- else if .source }}
      source:
{{ toYaml .source | indent 6 }}
      {{- end }}

      # Handle SyncPolicy Override
      {{- if .syncPolicy }}
      syncPolicy:
{{ toYaml .syncPolicy | indent 6 }}
      {{- end }}
