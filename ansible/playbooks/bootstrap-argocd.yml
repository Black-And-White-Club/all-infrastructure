---
# BOOTSTRAP ARGOCD + LICH KING ONLY
# Usage: ansible-playbook ansible/playbooks/bootstrap-argocd-only.yml

- name: Bootstrap ArgoCD + Lich King (no Terraform)
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    kubeconfig_path: "{{ lookup('env','HOME') }}/.kube/config-oci"
    argocd_namespace: argocd

    # Repo + files
    lich_king_file: "{{ playbook_dir }}/../../argocd-applications/the-lich-king/the-lich-king.yaml"
    # CRITICAL: Required to break the Chicken-Egg loop
    platform_project_file: "{{ playbook_dir }}/../../argocd-applications/platform/platform-project.yaml"
    argocd_values: "{{ playbook_dir }}/../../charts/argo-cd/values.yaml"

  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"

  tasks:
    ###########################################################################
    # PHASE 0: VALIDATION
    ###########################################################################
    - name: Display bootstrap plan
      debug:
        msg:
          - "========================================"
          - "BOOTSTRAP ARGOCD + LICH KING"
          - "========================================"
          - "This will:"
          - "  1. Install ArgoCD"
          - "  2. Bootstrap 'platform' Project (Manual)"
          - "  3. Apply Lich King (root orchestrator)"
          - "  4. Wait for ApplicationSets & Apps"

    - name: Verify required files exist
      stat:
        path: "{{ item }}"
      register: file_check
      failed_when: not file_check.stat.exists
      loop:
        - "{{ lich_king_file }}"
        - "{{ platform_project_file }}"
        - "{{ argocd_values }}"

    ###########################################################################
    # PHASE 1: CHECK CLUSTER
    ###########################################################################
    - name: Ensure kubeconfig exists
      stat:
        path: "{{ kubeconfig_path }}"
      register: kubeconfig_stat
      failed_when: not kubeconfig_stat.stat.exists

    - name: Verify cluster connectivity
      command: kubectl cluster-info
      register: cluster_info
      retries: 10
      delay: 3
      until: cluster_info.rc == 0
      changed_when: false

    ###########################################################################
    # PHASE 2: INSTALL ARGOCD
    ###########################################################################
    - name: Check if ArgoCD is already installed
      command: kubectl -n {{ argocd_namespace }} get deployment argocd-server
      register: argocd_check
      failed_when: false
      changed_when: false

    - name: Add Argo Helm repo
      command: helm repo add argo https://argoproj.github.io/argo-helm
      when: argocd_check.rc != 0
      changed_when: false

    - name: Update Helm repos
      command: helm repo update
      when: argocd_check.rc != 0
      changed_when: false

    - name: Install ArgoCD via Helm
      command: >
        helm upgrade --install argocd argo/argo-cd
        --namespace {{ argocd_namespace }}
        --create-namespace
        --values {{ argocd_values }}
        --wait --timeout 10m
      when: argocd_check.rc != 0

    - name: Wait for ArgoCD server
      command: kubectl wait --for=condition=available --timeout=300s deployment/argocd-server -n {{ argocd_namespace }}
      when: argocd_check.rc != 0
      changed_when: false

    ###########################################################################
    # PHASE 2.5: BOOTSTRAP PROJECT (CRITICAL FIX)
    ###########################################################################
    - name: Bootstrap Platform Project
      command: kubectl apply -f {{ platform_project_file }}
      register: project_apply

    - name: Display Project Status
      debug:
        msg: "Platform project applied. Lich King can now reference 'project: platform'."

    ###########################################################################
    # PHASE 3: APPLY LICH KING
    ###########################################################################
    - name: Apply Lich King
      command: kubectl apply -f {{ lich_king_file }}
      register: lich_king_apply

    - name: Display Lich King apply status
      debug:
        msg: "{{ lich_king_apply.stdout_lines }}"

    ###########################################################################
    # PHASE 4: WAIT FOR SYNC
    ###########################################################################
    # We added a check here to verify Lich King status before waiting
    - name: Check Lich King Status
      command: kubectl get app the-lich-king -n {{ argocd_namespace }} -o jsonpath='{.status.health.status}'
      register: lk_health
      retries: 5
      delay: 2
      ignore_errors: true

    - name: Debug Lich King Health
      debug:
        msg: "Lich King Health: {{ lk_health.stdout }}"

    - name: Wait for ApplicationSets
      shell: kubectl get applicationsets -n {{ argocd_namespace }} --no-headers | wc -l
      register: appset_count
      retries: 30
      delay: 10
      until: appset_count.stdout|int > 0
      changed_when: false

    - name: Show ApplicationSets
      command: kubectl get applicationsets -n {{ argocd_namespace }}
      register: appsets
      changed_when: false

    - name: Display ApplicationSets
      debug:
        msg: "{{ appsets.stdout_lines }}"

    - name: Wait for Applications (Infrastructure to bootstrap)
      shell: kubectl get applications -n {{ argocd_namespace }} --no-headers | wc -l
      register: apps_count
      retries: 60
      delay: 5
      until: apps_count.stdout|int > 0
      changed_when: false

    ###########################################################################
    # PHASE 5: FINAL STATUS
    ###########################################################################
    - name: List final applications
      command: kubectl get applications -n {{ argocd_namespace }}
      register: apps_final
      changed_when: false

    - name: Display summary
      debug:
        msg:
          - "========================================"
          - "BOOTSTRAP COMPLETE!"
          - "========================================"
          - "ArgoCD Installed & Running"
          - "Platform Project Bootstrapped"
          - "Lich King Applied"
          - "ApplicationSets Created"
          - ""
          - "Applications:"
          - "{{ apps_final.stdout }}"
          - ""
