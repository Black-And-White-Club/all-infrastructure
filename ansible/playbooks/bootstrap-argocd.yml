---
# Clean, safe ArgoCD bootstrap for OCI cluster

- name: Bootstrap ArgoCD (clean version)
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    kubeconfig_path: "{{ lookup('env','HOME') }}/.kube/config-oci"
    argocd_namespace: argocd
    lich_king_path: "{{ playbook_dir }}/../../argocd-applications/the-lich-king/the-lich-king.yaml"
    argocd_values: "{{ playbook_dir }}/../../charts/argo-cd/values.yaml"

  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"

  tasks:
    ###########################################################################
    # 0. VALIDATION
    ###########################################################################

    - name: Ensure kubeconfig exists
      stat:
        path: "{{ kubeconfig_path }}"
      register: kubeconf

    - name: Fail if kubeconfig is missing
      fail:
        msg: "Kubeconfig not found at {{ kubeconfig_path }}. Did you forget to export it?"
      when: not kubeconf.stat.exists

    - name: Ensure Lich King file exists
      stat:
        path: "{{ lich_king_path }}"
      register: lkfile

    - name: Fail if Lich King descriptor is missing
      fail:
        msg: "Lich King file not found at {{ lich_king_path }}. Fix the repo path."
      when: not lkfile.stat.exists

    - name: Ensure ArgoCD values file exists
      stat:
        path: "{{ argocd_values }}"
      register: valuesfile

    - name: Fail if ArgoCD Helm values file missing
      fail:
        msg: "ArgoCD values file not found at {{ argocd_values }}"
      when: not valuesfile.stat.exists

    ###########################################################################
    # 1. CHECK IF ARGOCD IS ALREADY INSTALLED
    ###########################################################################

    - name: Detect if ArgoCD namespace exists
      command: kubectl get ns {{ argocd_namespace }}
      register: ns_check
      failed_when: false
      changed_when: false

    - name: Detect if ArgoCD server exists
      command: kubectl -n {{ argocd_namespace }} get deploy argocd-server
      register: server_check
      failed_when: false
      changed_when: false

    ###########################################################################
    # 2. INSTALL ARGOCD (ONLY IF MISSING)
    ###########################################################################

    - name: Add ArgoCD Helm repo (idempotent)
      command: helm repo add argo https://argoproj.github.io/argo-helm
      failed_when: false
      changed_when: false

    - name: Helm repo update
      command: helm repo update
      changed_when: false

    - name: Install ArgoCD via Helm ONLY if missing
      when: server_check.rc != 0
      command: >
        helm upgrade --install argocd argo/argo-cd
        --namespace {{ argocd_namespace }}
        --create-namespace
        --values {{ argocd_values }}
        --wait --timeout 10m

    - name: Wait for ArgoCD server (only on fresh install)
      when: server_check.rc != 0
      command: kubectl wait --for=condition=available --timeout=300s
        deployment/argocd-server -n {{ argocd_namespace }}

    ###########################################################################
    # 3. APPLY THE LICH KING ROOT APPLICATION
    ###########################################################################

    - name: Check if Lich King application already exists
      command: kubectl -n {{ argocd_namespace }} get application the-lich-king
      register: lk_check
      failed_when: false
      changed_when: false

    - name: Apply Lich King root application (safe, idempotent)
      command: kubectl apply -f {{ lich_king_path }}
      register: lk_apply
      when: lk_check.rc != 0

    - name: Re-apply Lich King if it exists (ensures updates)
      command: kubectl apply -f {{ lich_king_path }}
      register: lk_reapply
      when: lk_check.rc == 0

    ###########################################################################
    # 4. OUTPUT RESULTS
    ###########################################################################

    - name: Display ArgoCD + Lich King status
      debug:
        msg:
          - "========================================"
          - "ArgoCD Bootstrap Complete!"
          - "========================================"
          - "ArgoCD Installed: {{ 'yes' if server_check.rc == 0 else 'fresh install' }}"
          - ""
          - "Lich King applied from:"
          - "  {{ lich_king_path }}"
          - ""
          - "To check status:"
          - "  kubectl get applicationsets -n argocd"
          - "  kubectl get applications -n argocd"
          - ""
          - "To watch apps sync:"
          - "  watch kubectl get applications -n argocd"
          - ""
          - "========================================"
