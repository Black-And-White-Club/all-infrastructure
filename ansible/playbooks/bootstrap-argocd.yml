---
- name: Bootstrap ArgoCD + root application (no Terraform)
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    kubeconfig_path: "{{ lookup('env','HOME') }}/.kube/config-oci"
    argocd_namespace: argocd

    argocd_values: "{{ playbook_dir }}/../../charts/argo-cd/values.yaml"
    root_app_file: "{{ playbook_dir }}/../../argocd/root-app.yaml"
    project_files:
      - "{{ playbook_dir }}/../../argocd/projects/platform-project.yaml"
      - "{{ playbook_dir }}/../../argocd/projects/observability-project.yaml"
      - "{{ playbook_dir }}/../../argocd/projects/apps-project.yaml"

  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"

  tasks:
    - name: Display bootstrap plan
      debug:
        msg:
          - "========================================"
          - "BOOTSTRAP ARGOCD + ROOT APPLICATION"
          - "========================================"
          - "This will:"
          - "  1. Install ArgoCD (Helm)"
          - "  2. Apply project definitions (platform / observability / apps)"
          - "  3. Apply argocd/root-app.yaml"
          - "  4. Let the root app reconcile clusters + applications"

    - name: Verify required files exist
      stat:
        path: "{{ item }}"
      register: required_files
      failed_when: not required_files.stat.exists
      loop: "{{ project_files + [root_app_file, argocd_values] }}"

    - name: Ensure kubeconfig exists
      stat:
        path: "{{ kubeconfig_path }}"
      register: kubeconfig_stat
      failed_when: not kubeconfig_stat.stat.exists

    - name: Verify cluster connectivity
      command: kubectl cluster-info
      register: cluster_info
      retries: 10
      delay: 3
      until: cluster_info.rc == 0
      changed_when: false

    - name: Check if ArgoCD is already installed
      command: kubectl -n {{ argocd_namespace }} get deployment argocd-server
      register: argocd_check
      failed_when: false
      changed_when: false

    - name: Ensure Argo Helm repo is added
      command: helm repo add argo https://argoproj.github.io/argo-helm
      failed_when: false
      changed_when: false

    - name: Update Helm repos
      command: helm repo update
      failed_when: false
      changed_when: false

    - name: Install or upgrade ArgoCD via Helm (idempotent)
      command: >
        helm upgrade --install argocd argo/argo-cd
        --namespace {{ argocd_namespace }}
        --create-namespace
        --values {{ argocd_values }}
        --wait --timeout 10m
      register: helm_upgrade

    - name: Wait for ArgoCD server
      command: kubectl wait --for=condition=available --timeout=300s deployment/argocd-server -n {{ argocd_namespace }}
      when: helm_upgrade is succeeded or argocd_check.rc == 0
      changed_when: false

    - name: Apply ArgoCD projects
      command: kubectl apply -f "{{ item }}"
      loop: "{{ project_files }}"
      register: project_results

    - name: Apply root application
      command: kubectl apply -f "{{ root_app_file }}"
      register: root_apply

    - name: Wait for root application to sync
      command: kubectl wait --for=condition=Synced --timeout=5s application/root -n {{ argocd_namespace }}
      register: root_sync
      retries: 30
      delay: 5
      until: root_sync.rc == 0
      changed_when: false

    - name: List ArgoCD applications
      command: kubectl get applications -n {{ argocd_namespace }}
      register: apps_final
      changed_when: false

    - name: Display summary
      debug:
        msg:
          - "========================================"
          - "BOOTSTRAP COMPLETE!"
          - "========================================"
          - "ArgoCD Installed & Running"
          - "Projects applied: {{ project_files | length }}"
          - "Root application deployed"
          - "Applications in {{ argocd_namespace }}:"
          - "{{ apps_final.stdout }}"
