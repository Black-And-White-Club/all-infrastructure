name: Terraform Plan

on:
  pull_request:
    branches: [main]
    paths:
      - "terraform/**"

permissions:
  pull-requests: write
  contents: read

jobs:
  terraform-plan:
    name: Terraform Plan
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: terraform

    env:
      # Required for OCI S3-compatible backend (chunked encoding not supported)
      AWS_REQUEST_CHECKSUM_CALCULATION: when_required
      AWS_RESPONSE_CHECKSUM_VALIDATION: when_required
      # OCI Auth
      TF_VAR_tenancy_ocid: ${{ secrets.OCI_TENANCY_OCID }}
      TF_VAR_user_ocid: ${{ secrets.OCI_USER_OCID }}
      TF_VAR_region: ${{ secrets.OCI_REGION }}
      # Non-auth variables (OCIDs, config — not sensitive but gitignored)
      TF_VAR_compartment_ocid: ${{ secrets.TF_VAR_COMPARTMENT_OCID }}
      TF_VAR_resume_compartment_ocid: ${{ secrets.TF_VAR_RESUME_COMPARTMENT_OCID }}
      TF_VAR_frolf_bot_compartment_ocid: ${{ secrets.TF_VAR_FROLF_BOT_COMPARTMENT_OCID }}
      TF_VAR_resume_bucket_ocid: ${{ secrets.TF_VAR_RESUME_BUCKET_OCID }}
      TF_VAR_frolf_bot_bucket_ocid: ${{ secrets.TF_VAR_FROLF_BOT_BUCKET_OCID }}
      TF_VAR_resume_repo_ocid: ${{ secrets.TF_VAR_RESUME_REPO_OCID }}
      TF_VAR_frolf_bot_repo_ocid: ${{ secrets.TF_VAR_FROLF_BOT_REPO_OCID }}
      TF_VAR_namespace: ${{ secrets.TF_VAR_NAMESPACE }}
      TF_VAR_availability_domain: ${{ secrets.TF_VAR_AVAILABILITY_DOMAIN }}
      TF_VAR_image_id: ${{ secrets.TF_VAR_IMAGE_ID }}
      TF_VAR_ssh_public_key: ${{ secrets.TF_VAR_SSH_PUBLIC_KEY }}
      TF_VAR_admin_group_ocid: ${{ secrets.TF_VAR_ADMIN_GROUP_OCID }}
      TF_VAR_user_email_prefix: ${{ secrets.TF_VAR_USER_EMAIL_PREFIX }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "~1.9"

      - name: Configure OCI credentials
        run: |
          mkdir -p ~/.oci
          echo "${{ secrets.OCI_PRIVATE_KEY }}" > ~/.oci/private_key.pem
          chmod 600 ~/.oci/private_key.pem
          {
            echo '[DEFAULT]'
            echo "user=${{ secrets.OCI_USER_OCID }}"
            echo "fingerprint=${{ secrets.OCI_FINGERPRINT }}"
            echo 'key_file=~/.oci/private_key.pem'
            echo "tenancy=${{ secrets.OCI_TENANCY_OCID }}"
            echo "region=${{ secrets.OCI_REGION }}"
          } > ~/.oci/config

      - name: terraform init
        run: |
          terraform init \
            -backend-config="access_key=${{ secrets.OCI_S3_ACCESS_KEY }}" \
            -backend-config="secret_key=${{ secrets.OCI_S3_SECRET_KEY }}"

      - name: terraform plan
        id: plan
        continue-on-error: true
        run: |
          terraform plan -no-color -out=tfplan 2>&1 | tee plan.txt
          echo "exitcode=${PIPESTATUS[0]}" >> $GITHUB_OUTPUT

      - name: Post plan as PR comment
        uses: actions/github-script@v7
        if: always()
        with:
          script: |
            const fs = require('fs');
            const plan = fs.readFileSync('terraform/plan.txt', 'utf8');
            // Trim to avoid hitting GitHub comment size limits
            const MAX = 60000;
            const body = plan.length > MAX
              ? plan.slice(0, MAX) + '\n\n... (truncated — see Actions logs for full output)'
              : plan;
            const comment = `### Terraform Plan\n\`\`\`\n${body}\n\`\`\``;
            // Delete previous plan comments to keep the PR clean
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            for (const c of comments) {
              if (c.body.startsWith('### Terraform Plan')) {
                await github.rest.issues.deleteComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: c.id,
                });
              }
            }
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment,
            });
