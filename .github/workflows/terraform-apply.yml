name: Terraform Apply

on:
  push:
    branches: [main]
    paths:
      - "terraform/**"

permissions:
  contents: read
  pull-requests: write

# Require manual approval via GitHub environment before apply runs.
# Configure "production" environment in repo Settings → Environments
# and add required reviewers there.
jobs:
  terraform-apply:
    name: Terraform Apply
    runs-on: ubuntu-latest
    environment: production
    defaults:
      run:
        working-directory: terraform

    env:
      # Required for OCI S3-compatible backend (chunked encoding not supported)
      AWS_REQUEST_CHECKSUM_CALCULATION: when_required
      AWS_RESPONSE_CHECKSUM_VALIDATION: when_required
      # OCI Auth
      TF_VAR_tenancy_ocid: ${{ secrets.OCI_TENANCY_OCID }}
      TF_VAR_user_ocid: ${{ secrets.OCI_USER_OCID }}
      TF_VAR_region: ${{ secrets.OCI_REGION }}
      # Non-auth variables (OCIDs, config)
      TF_VAR_compartment_ocid: ${{ secrets.TF_VAR_COMPARTMENT_OCID }}
      TF_VAR_resume_compartment_ocid: ${{ secrets.TF_VAR_RESUME_COMPARTMENT_OCID }}
      TF_VAR_frolf_bot_compartment_ocid: ${{ secrets.TF_VAR_FROLF_BOT_COMPARTMENT_OCID }}
      TF_VAR_resume_bucket_ocid: ${{ secrets.TF_VAR_RESUME_BUCKET_OCID }}
      TF_VAR_frolf_bot_bucket_ocid: ${{ secrets.TF_VAR_FROLF_BOT_BUCKET_OCID }}
      TF_VAR_resume_repo_ocid: ${{ secrets.TF_VAR_RESUME_REPO_OCID }}
      TF_VAR_frolf_bot_repo_ocid: ${{ secrets.TF_VAR_FROLF_BOT_REPO_OCID }}
      TF_VAR_namespace: ${{ secrets.TF_VAR_NAMESPACE }}
      TF_VAR_availability_domain: ${{ secrets.TF_VAR_AVAILABILITY_DOMAIN }}
      TF_VAR_image_id: ${{ secrets.TF_VAR_IMAGE_ID }}
      TF_VAR_ssh_public_key: ${{ secrets.TF_VAR_SSH_PUBLIC_KEY }}
      TF_VAR_admin_group_ocid: ${{ secrets.TF_VAR_ADMIN_GROUP_OCID }}
      TF_VAR_user_email_prefix: ${{ secrets.TF_VAR_USER_EMAIL_PREFIX }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "~1.9"

      - name: Configure OCI credentials
        run: |
          mkdir -p ~/.oci
          echo "${{ secrets.OCI_PRIVATE_KEY }}" > ~/.oci/private_key.pem
          chmod 600 ~/.oci/private_key.pem
          {
            echo '[DEFAULT]'
            echo "user=${{ secrets.OCI_USER_OCID }}"
            echo "fingerprint=${{ secrets.OCI_FINGERPRINT }}"
            echo 'key_file=~/.oci/private_key.pem'
            echo "tenancy=${{ secrets.OCI_TENANCY_OCID }}"
            echo "region=${{ secrets.OCI_REGION }}"
          } > ~/.oci/config

      - name: terraform init
        run: |
          terraform init \
            -backend-config="access_key=${{ secrets.OCI_S3_ACCESS_KEY }}" \
            -backend-config="secret_key=${{ secrets.OCI_S3_SECRET_KEY }}"

      - name: terraform apply
        id: apply
        run: |
          set -o pipefail
          # Capture output; filter to summary lines + Terraform diagnostic borders.
          # The box-drawing chars (│ ╷ ╵) are Terraform's diagnostic message borders.
          terraform apply -auto-approve -no-color 2>&1 \
            | grep -E "^(Apply|Plan|Error|Warning|│|╷|╵)"

      - name: Find associated PR and comment apply result
        uses: actions/github-script@v7
        if: always()
        with:
          script: |
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'closed',
              sort: 'updated',
              direction: 'desc',
              per_page: 5,
            });
            const pr = prs.find(p => p.merge_commit_sha === context.sha);
            if (!pr) { console.log('No PR found for this commit.'); return; }
            const status = '${{ job.status }}';
            const emoji = status === 'success' ? '✅' : '❌';
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              body: `${emoji} **Terraform Apply** — ${status}\n\nSee [workflow run](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) for full details.`,
            });
