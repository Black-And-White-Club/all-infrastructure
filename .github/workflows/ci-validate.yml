name: CI — Validate Infrastructure

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  # ── Terraform: lint + security scan ────────────────────────────────────────
  terraform-lint:
    name: Terraform Lint & Security
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: terraform
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "~1.9"

      - name: terraform init (backend=false — no remote state needed for lint)
        run: terraform init -backend=false

      - name: terraform validate
        run: terraform validate

      - name: Setup tflint
        uses: terraform-linters/setup-tflint@v4
        with:
          tflint_version: latest

      - name: tflint
        run: |
          tflint --init
          tflint --format=compact

      - name: tfsec
        uses: aquasecurity/tfsec-action@v1.0.3
        with:
          working_directory: terraform
          soft_fail: false

  # ── Helm: lint + schema validation ─────────────────────────────────────────
  helm-lint:
    name: Helm Lint & Schema
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.17.0

      - name: Install kubeconform
        run: |
          wget -qO- https://github.com/yannh/kubeconform/releases/latest/download/kubeconform-linux-amd64.tar.gz \
            | tar xz -C /usr/local/bin
          chmod +x /usr/local/bin/kubeconform

      - name: Lint charts/
        run: |
          for d in charts/*/; do
            [ -d "$d" ] || continue
            # Skip dirs that are values-only (no Chart.yaml)
            [ -f "$d/Chart.yaml" ] || continue
            echo "── Linting $d"
            helm lint "$d"
            if [ -f "$d/values.yaml" ]; then
              helm template "test-release" "$d" -f "$d/values.yaml" \
                | kubeconform -schema-location default -strict -
            fi
          done

  # ── Kustomize: build + kube-linter ─────────────────────────────────────────
  kustomize-lint:
    name: Kustomize Render & Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup kustomize
        uses: imranismail/setup-kustomize@v2
        with:
          kustomize-version: "5.x"

      - name: Install kube-linter
        run: |
          curl -sSL https://github.com/stackrox/kube-linter/releases/latest/download/kube-linter-linux.tar.gz \
            | tar xz -C /usr/local/bin
          chmod +x /usr/local/bin/kube-linter

      - name: Build and lint each kustomize overlay
        run: |
          FAILED=0
          for overlay in kustomize/*/overlays/production; do
            [ -d "$overlay" ] || continue
            APP=$(echo "$overlay" | cut -d/ -f2)
            echo "── Building $APP"
            if ! kustomize build "$overlay" > /tmp/rendered-"$APP".yaml 2>&1; then
              echo "ERROR: kustomize build failed for $APP"
              cat /tmp/rendered-"$APP".yaml
              FAILED=1
              continue
            fi
            echo "── kube-linter: $APP"
            kube-linter lint /tmp/rendered-"$APP".yaml \
              --config .kube-linter.yaml || FAILED=1
          done
          exit $FAILED
